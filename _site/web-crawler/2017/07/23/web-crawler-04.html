<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="크롤러 공부 3일차">
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@jeonghwan0424" />
  <meta name="twitter:creator" content="@jeonghwan0424" />
  <meta property="og:type" content="article" />
  <meta property="og:url" content="http://localhost:4000/web-crawler/2017/07/23/web-crawler-04.html" />
  <meta property="og:title" content="크롤러 공부 3일차" />
  <meta property="og:description" content="크롤러 공부 3일차" />
  <meta property="og:image" content="http://localhost:4000/assets/imgs/me.jpg" />
  <meta property="og:site_name" content="김대성 블로그" />
  <meta property="og:locale" content="ko_kr" />
  <title>크롤러 공부 3일차</title>
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="http://localhost:4000/web-crawler/2017/07/23/web-crawler-04.html">
  <link rel="alternate" type="application/rss+xml" title="김대성 블로그" href="http://localhost:4000/feed.xml">
  <link rel="shortcut icon" href="/assets/imgs/favicon.ico" />
</head>

  <body>
    <div class='row'>
      <header class="site-header">
  <div class="wrapper">
    <h1 class="site-title site-title-sm">
      <a class="" href="/">김대성 블로그</a>
    </h1>
  </div>
</header>

      <div class="page-content">
        <article id="post" class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <div class="wrapper">
      <h1 class="post-title" itemprop="name headline">크롤러 공부 3일차</h1>
      <div class="post-meta">


  <span class="date">
    <i class="fa fa-clock-o" aria-hidden="true"></i> 2017년 07월 23일
</span>

</div>
    </div>
  </header>

  <div class="wrapper">
    <div class="post-content" itemprop="articleBody">
      <h2 id="크롤러-공부-3일차">크롤러 공부 3일차</h2>

<h2 id="electron으로-데스크탑-애플리케이션-작성">Electron으로 데스크탑 애플리케이션 작성</h2>

<h2 id="electron이란">Electron이란?</h2>

<p>‘웹 브라우저 안에 Node.JS를 넣은것’ Chromium + Node.js 조합해서 만든것</p>

<p><a href="https://electron.atom.io/">electron</a></p>

<p><a href="https://nwjs.io/">NW.js</a></p>

<h2 id="electron의-장점과-단점">Electron의 장점과 단점</h2>
<ul>
  <li>
    <p>최대장점 웹 기술(HTML5/자바스크립트/CSS)을 이용하여 네이티브 애플리케이션을 쉽게 만들수 있다는 점</p>
  </li>
  <li>
    <p>단점 웹 브라우저인 Chromium을 그대로 포함해야 하므로 배포 
사이즈가 커져서 아무리 간단한 앱이라도 수십 ~ 수백 MB 저장공간 필요</p>
  </li>
</ul>

<h2 id="자바스크립트로-렌더링되는-페이지도-ok">자바스크립트로 렌더링되는 페이지도 OK</h2>
<ul>
  <li>최근에는 모든 내용이 자바스크립트로 렌더링되는 웹 페이지가 늘고 있음</li>
  <li>단순 HTML을 다운로드하면 내용이 텅 비어 있음</li>
</ul>

<p><img src="/assets/imgs/2017/07/22/2017-07-22-web-crawler-01.png" alt="Electron 설치" /></p>

<p><img src="/assets/imgs/2017/07/22/2017-07-22-web-crawler-02.png" alt="Electron 실행" /></p>

<p><img src="/assets/imgs/2017/07/22/2017-07-22-web-crawler-03.png" alt="Electron" /></p>

<h2 id="직접-준비한-html을-electron에-표시">직접 준비한 HTML을 Electron에 표시</h2>

<p><img src="/assets/imgs/2017/07/22/2017-07-22-web-crawler-04.png" alt="Electron" /></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="s2">"test-app"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"version"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"0.1.0"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"main"</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="s2">"main.js"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span></code></pre></div></div>

<p>메인프로그램 main.js</p>
<ul>
  <li>메인윈도우 디스플레이</li>
  <li>시스템 이벤트에 대한 처리코드</li>
</ul>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 필요 모듈 로드</span>
<span class="kd">var</span> <span class="nx">electron</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'electron'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">app</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">BrowserWindow</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">BrowserWindow</span><span class="p">;</span>

<span class="c1">// 준비가 된 시점에 호출되는 이벤트 ※1</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'ready'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 메인 윈도우 생성</span>
    <span class="nx">win</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BrowserWindow</span><span class="p">({</span>
        <span class="na">width</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
        <span class="na">height</span><span class="p">:</span> <span class="mi">600</span>
    <span class="p">});</span>
    <span class="c1">// 지정 URL 로드</span>
    <span class="nx">win</span><span class="p">.</span><span class="nx">loadURL</span><span class="p">(</span><span class="s1">'file://'</span> <span class="o">+</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/index.html'</span><span class="p">);</span> <span class="c1">// ※2</span>
    <span class="nx">win</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'closed'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">win</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>HTML은 일반HTML 
HTML 내의 자바스크립트에서 사용할 수 없는 progress객체가 이용됨</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>Test App<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;script&gt;</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"info"</span><span class="p">);</span>
      <span class="nx">info</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span>
        <span class="s2">"Node ver."</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s2">"&lt;br&gt;"</span> <span class="o">+</span>
        <span class="s2">"atom ver."</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="nx">versions</span><span class="p">[</span><span class="s1">'electron'</span><span class="p">];</span>
  <span class="p">};</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;h1&gt;</span>test app<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">"info"</span><span class="nt">&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>

</code></pre></div></div>

<p><img src="/assets/imgs/2017/07/22/2017-07-22-web-crawler-05.png" alt="Electron" /></p>

<p><img src="/assets/imgs/2017/07/22/2017-07-22-web-crawler-06.png" alt="Electron" /></p>

<h2 id="메인-프로세스와-렌더링-프로세스-간의-통신">메인 프로세스와 렌더링 프로세스 간의 통신</h2>

<ul>
  <li>
    <p>Elctron 시작</p>
  </li>
  <li>
    <p>Electron은 package.json에 적힌 메인 프로그램(자바스크립트) 실행</p>
  </li>
  <li>
    <p>메인 프로그램에서 브라우저 창을 생성</p>
  </li>
  <li>
    <p>브라우저 창에 임의의 HTML을 로드</p>
  </li>
</ul>

<p>Electron에서 메인 프로그램을 메인 프로세스</p>

<p>HTML에서 실행되는 후자의 프로그램을 렌더링 프로세스</p>

<p>프로세스 두개인 이유</p>
<ul>
  <li>웹 브라우저에서는 보안을 위해 샌드 박스 내에서 HTML이 실행됨
파일 같은 로컬 리소스에 접근할 수 없음</li>
</ul>

<p>렌더링 프로세스에서는 위험한 조작을 할수 없음</p>

<p>메인 프로세스에서는 Node.js의 API를 자유롭게 사용가능</p>
<ul>
  <li>렌더링 프로세스가 메인 프로세스에게 필요한 처리를 의뢰 
웹 브라우저에서는 수행할 수 없었던 각종 처리를 할 수 있음</li>
</ul>

<p>메인 프로세스와 렌더링 프로세스 간의 통신을 위한 IPC 모듈</p>

<h2 id="동기적인-ipc-통신">동기적인 IPC 통신</h2>
<ul>
  <li>동기적 통신</li>
  <li>비동기적 통신</li>
</ul>

<h2 id="ipc-통신을-수행하는-실제-프로그램">IPC 통신을 수행하는 실제 프로그램</h2>

<p>메인 프로세스</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 모듈 로드 </span>
<span class="kd">var</span> <span class="nx">electron</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'electron'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">app</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">BrowserWindow</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">BrowserWindow</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">ipc</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">ipcMain</span><span class="p">;</span>

<span class="c1">// 메인 윈도우 기동 </span>
<span class="kd">var</span> <span class="nx">mainWindow</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'ready'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">mainWindow</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BrowserWindow</span><span class="p">({</span><span class="na">width</span><span class="p">:</span><span class="mi">800</span><span class="p">,</span> <span class="na">height</span><span class="p">:</span><span class="mi">600</span><span class="p">});</span>
  <span class="nx">mainWindow</span><span class="p">.</span><span class="nx">loadURL</span><span class="p">(</span><span class="s1">'file://'</span> <span class="o">+</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/index.html'</span><span class="p">);</span>
  <span class="nx">mainWindow</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'closed'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="nx">mainWindow</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="c1">// 동기적 메시지 수신 </span>
<span class="nx">ipc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'mul-sync'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span> <span class="c1">// 콘솔 출력 </span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">returnValue</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">a</span> <span class="o">*</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>
<span class="p">});</span>

<span class="c1">// 비동기적 메시지 수신</span>
<span class="nx">ipc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'mul-async'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span><span class="c1">// 콘솔 출력 </span>
  
  <span class="c1">// 렌더링 프로세스에 반환 </span>
  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">a</span> <span class="o">*</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">b</span><span class="p">;</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">sender</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'mul-async-reply'</span><span class="p">,</span> <span class="nx">result</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>렌더링 프로세스</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;&lt;head&gt;</span>
<span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
<span class="nt">&lt;title&gt;</span>IPC Test<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;script&gt;</span>

<span class="c1">// 모듈 로드 </span>
<span class="kd">var</span> <span class="nx">electron</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'electron'</span><span class="p">);</span>

<span class="c1">// IPC통신 수행</span>
<span class="kd">var</span> <span class="nx">ipc</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">ipcRenderer</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">info</span><span class="p">;</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">info</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'info'</span><span class="p">);</span>
  <span class="nx">testSync</span><span class="p">();</span>
  <span class="nx">testASync</span><span class="p">();</span>
<span class="p">};</span>

<span class="c1">// 동기적 송신 수행 </span>
<span class="kd">function</span> <span class="nx">testSync</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 메인 프로세스에 인자를 송신하여 결과를 획득</span>
  <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">ipc</span><span class="p">.</span><span class="nx">sendSync</span><span class="p">(</span><span class="s1">'mul-sync'</span><span class="p">,</span> <span class="p">{</span><span class="na">a</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span> <span class="na">b</span><span class="p">:</span><span class="mi">2</span><span class="p">});</span>
  <span class="nx">msg</span><span class="p">(</span><span class="s2">"sync result="</span> <span class="o">+</span> <span class="nx">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 비동기적 송신 수행 </span>
<span class="kd">function</span> <span class="nx">testASync</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 메인 프로세스에 인자를 송신</span>
  <span class="nx">ipc</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">'mul-async'</span><span class="p">,</span> <span class="p">{</span><span class="na">a</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span> <span class="na">b</span><span class="p">:</span><span class="mi">2</span><span class="p">});</span>
  
  <span class="c1">// 비동기 통신으로 결과를 받았을 때</span>
  <span class="nx">ipc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'mul-async-reply'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">msg</span><span class="p">(</span><span class="s2">"async result="</span> <span class="o">+</span> <span class="nx">arg</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">msg</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">info</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="nx">msg</span> <span class="o">+</span> <span class="s2">"&lt;br&gt;"</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;&lt;body&gt;</span>
  <span class="nt">&lt;h1&gt;</span>IPC TEST<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">"info"</span><span class="nt">&gt;&lt;/p&gt;</span>
<span class="nt">&lt;/body&gt;&lt;/html&gt;</span>

</code></pre></div></div>

<p><img src="/assets/imgs/2017/07/22/2017-07-22-web-crawler-07.png" alt="Electron" /></p>

<p><img src="/assets/imgs/2017/07/22/2017-07-22-web-crawler-08.png" alt="Electron" /></p>

<h2 id="electron으로-스크린-캡처">Electron으로 스크린 캡처</h2>

<p>Electron 화면 캡처를 위한 메소드
BrowerWindow.capturePage()메소드 준비</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//브라우저 윈도우 생성</span>
<span class="nx">win</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BrowserWindow</span><span class="p">();</span>
<span class="c1">//...</span>
<span class="c1">//브라우저 화면을 캡처</span>
<span class="nx">win</span><span class="p">.</span><span class="nx">capturePage</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">img</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">png</span> <span class="o">=</span> <span class="nx">img</span><span class="p">.</span><span class="nx">toPng</span><span class="p">();</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="s1">'screenshot.png'</span><span class="p">,</span><span class="nx">png</span><span class="p">);</span>
<span class="p">})</span> 
</code></pre></div></div>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="s2">"screenshot-app"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"version"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"0.1.0"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"main"</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="s2">"main.js"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 변수 선언</span>
<span class="kd">var</span> <span class="nx">TARGET_URL</span> <span class="o">=</span> <span class="s2">"https://atom.io"</span><span class="p">;</span> <span class="c1">// 대상 웹 사이트</span>

<span class="c1">// 모듈 로드</span>
<span class="kd">var</span> <span class="nx">electron</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'electron'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">app</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">BrowserWindow</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">BrowserWindow</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>

<span class="c1">// 메인 윈도우 기동</span>
<span class="kd">var</span> <span class="nx">win</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'ready'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
	<span class="nx">win</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BrowserWindow</span><span class="p">({</span><span class="na">width</span><span class="p">:</span><span class="mi">1024</span><span class="p">,</span> <span class="na">height</span><span class="p">:</span><span class="mi">800</span><span class="p">});</span>
	<span class="nx">win</span><span class="p">.</span><span class="nx">loadURL</span><span class="p">(</span><span class="nx">TARGET_URL</span><span class="p">);</span>
	<span class="c1">// 페이지 로드가 완료되면 캡쳐 수행</span>
	<span class="nx">win</span><span class="p">.</span><span class="nx">webContents</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'did-finish-load'</span><span class="p">,</span><span class="nx">captureFunc</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 캡쳐 처리</span>
<span class="kd">function</span> <span class="nx">captureFunc</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">win</span><span class="p">.</span><span class="nx">capturePage</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="s1">'screenshot.png'</span><span class="p">,</span> <span class="nx">img</span><span class="p">.</span><span class="nx">toPng</span><span class="p">());</span>
	<span class="p">});</span>
<span class="p">}</span>

</code></pre></div></div>

<p><img src="/assets/imgs/2017/07/22/2017-07-22-web-crawler-09.png" alt="Electron" /></p>

<h2 id="매일-오후-네이버-금융-페이지를-캡처하여-저장">매일 오후 네이버 금융 페이지를 캡처하여 저장</h2>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 네이버 금융 페이지</span>
<span class="kd">var</span> <span class="nx">TARGET_URL</span> <span class="o">=</span> <span class="s2">"http://finance.naver.com"</span><span class="p">;</span>

<span class="c1">// 모듈 로드 </span>
<span class="kd">var</span> <span class="nx">electron</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'electron'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">app</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">BrowserWindow</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">BrowserWindow</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>

<span class="c1">// 메인 윈도우 기동 </span>
<span class="kd">var</span> <span class="nx">win</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'ready'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">win</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BrowserWindow</span><span class="p">({</span><span class="na">width</span><span class="p">:</span><span class="mi">800</span><span class="p">,</span> <span class="na">height</span><span class="p">:</span><span class="mi">800</span><span class="p">});</span>
  <span class="nx">win</span><span class="p">.</span><span class="nx">loadURL</span><span class="p">(</span><span class="nx">TARGET_URL</span><span class="p">);</span>
  <span class="c1">// 페이지 로드가 완료되면 캡쳐</span>
  <span class="nx">win</span><span class="p">.</span><span class="nx">webContents</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'did-finish-load'</span><span class="p">,</span> <span class="nx">captureFunc</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 캡쳐 처리 함수 </span>
<span class="kd">function</span> <span class="nx">captureFunc</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 일자를 파일 이름에 붙여서 파일에 저장 --- (※1)</span>
  <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">fname</span> <span class="o">=</span> <span class="s2">"finance-"</span> <span class="o">+</span> <span class="nx">t</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">+</span>
    <span class="s2">"-"</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">t</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">())</span> <span class="o">+</span>
    <span class="s2">"-"</span> <span class="o">+</span> <span class="nx">t</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">+</span> <span class="s2">".png"</span><span class="p">;</span>
    
  <span class="nx">win</span><span class="p">.</span><span class="nx">capturePage</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">fname</span><span class="p">,</span> <span class="nx">img</span><span class="p">.</span><span class="nx">toPng</span><span class="p">());</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">quit</span><span class="p">();</span> <span class="c1">// 애플리케이션 자동 종료</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>cron 환경에서도 Electron이 실행될 수 있도록 환경 변수를 설정한 배치 파일을 만든다  ‘crontab -e’를 수행하여 원하는 시점에
배치 파일이 수행되도록 설정</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="c"># 현재 디렉토리 설정</span>
<span class="nv">CDIR</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>
<span class="nb">cd</span> <span class="nv">$CDIR</span>

<span class="c"># atom-shell 기동</span>
/usr/local/bin/atom-shell <span class="nv">$CDIR</span>/finance-capture-app/ 

</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>45 15 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /path/to/finance-capture-app-cron.sh
</code></pre></div></div>

<p><img src="/assets/imgs/2017/07/22/2017-07-22-web-crawler-10.png" alt="Electron" /></p>

<h2 id="미세한-조정을-위해-딜레이-주기">미세한 조정을 위해 딜레이 주기</h2>

<p>setTimeout()</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//촬영 전 대기시간 </span>
<span class="kd">var</span> <span class="nx">DELAY_TIME</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// 1초</span>

<span class="c1">// 구글에서 이미지 검색 </span>
<span class="kd">var</span> <span class="nx">WORD</span> <span class="o">=</span> <span class="s2">"고양이"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">TARGET_URL</span> <span class="o">=</span> <span class="s2">"https://www.google.co.kr/search"</span> <span class="o">+</span>
      <span class="s2">"?source=lnms&amp;tbm=isch&amp;q="</span> <span class="o">+</span> 
      <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">WORD</span><span class="p">);</span>

<span class="c1">// 모듈 로드</span>
<span class="kd">var</span> <span class="nx">electron</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'electron'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">app</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">BrowserWindow</span> <span class="o">=</span> <span class="nx">electron</span><span class="p">.</span><span class="nx">BrowserWindow</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'fs'</span><span class="p">);</span>

<span class="c1">// 메인 윈도우 기동</span>
<span class="kd">var</span> <span class="nx">win</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'ready'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="nx">win</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BrowserWindow</span><span class="p">({</span><span class="na">width</span><span class="p">:</span><span class="mi">1024</span><span class="p">,</span> <span class="na">height</span><span class="p">:</span><span class="mi">800</span><span class="p">});</span>
  <span class="nx">win</span><span class="p">.</span><span class="nx">loadURL</span><span class="p">(</span><span class="nx">TARGET_URL</span><span class="p">);</span>
  <span class="c1">// 페이지 로드가 완료되면 캡쳐 함수를 호출 </span>
  <span class="nx">win</span><span class="p">.</span><span class="nx">webContents</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'did-finish-load'</span><span class="p">,</span> <span class="nx">captureFunc</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// 캡쳐 처리 --- (※1)</span>
<span class="kd">function</span> <span class="nx">captureFunc</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 딜레이를 준다 </span>
  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 적절한 이름으로 저장한다. </span>
    <span class="kd">var</span> <span class="nx">fname</span> <span class="o">=</span> <span class="s2">"cat-"</span> <span class="o">+</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="s2">".png"</span><span class="p">;</span>
    <span class="nx">win</span><span class="p">.</span><span class="nx">capturePage</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">fname</span><span class="p">,</span> <span class="nx">img</span><span class="p">.</span><span class="nx">toPng</span><span class="p">());</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">quit</span><span class="p">();</span> <span class="c1">// 앱 자동 종료 </span>
    <span class="p">});</span>
  <span class="p">},</span> <span class="nx">DELAY_TIME</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p><img src="/assets/imgs/2017/07/22/2017-07-22-web-crawler-11.png" alt="Electron" /></p>

<h2 id="캡처할-범위를-지정">캡처할 범위를 지정</h2>
<p>capturePage() 메소드에 캡처할 화면의 영역을 지정
BrowserWindow.capturePage([rect,]callback)</p>

<p>rect 객체 
X 좌표 X(좌측 상단이 원점)
Y 좌표 Y(좌측 상단이 원점)
width   영역의 폭
height  영역의 높이</p>


    </div>
    <div class="post-meta">

<span>
      
      
      <a class="tag-link" data-tag-name="web-crawler"
        href="/tags.html#web-crawler">#web-crawler</a>
    <a class="tag-link" data-tag-name="nodejs"
        href="/tags.html#nodejs">#nodejs</a>
    <a class="tag-link" data-tag-name="javascript"
        href="/tags.html#javascript">#javascript</a>
    </span>
</div>
    <div><div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = 'https://connect.facebook.net/ko_KR/sdk.js#xfbml=1&version=v3.0&appId=116889428386183&autoLogAppEvents=1';
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="fb-like" data-href="http://localhost:4000/web-crawler/2017/07/23/web-crawler-04.html" data-layout="standard" data-action="like" data-size="small" data-show-faces="true" data-share="true"></div></div>
    <div><div id="disqus_thread"></div>
<script>
  /**
   *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
   *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
   */
  /*
   var disqus_config = function () {
   this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
   this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
   };
   */
  (function() {  // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');

    s.src = '//dskim-1.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>
  </div>
</article>

      </div>
    </div>
    <div class="wrapper">
  <footer class="site-footer">
    <ul class="site-footer-links list-inline">
      <li class="site-footer-link">
        <a href="/feed.xml">
          RSS
        </a>
      </li>
      
      <li class="site-footer-link">
        <a href="mailto:deasung.kim2622@gmail.com">
          이메일
        </a>
      </li>
      
      
      <li class="site-footer-link">
        <a href="https://github.com/deasung">
          깃헙
        </a>
      </li>
      
    </ul>
  </footer>
</div>

<script src="/assets/js/main.js"></script>

  </body>
</html>
